---
params:
  age_lower: !r NA_real_
  age_upper: !r NA_real_
  authorship_1_chr: ''
  authorship_2_chr: ''
  data_pckg_chr: springtides
  disorder_chr: !r NA_character_
  format_chr: !r NA_character_
  gdist_dbl: !r NA_real_
  gdist_ttime_chr: !r NA_character_
  input_ls_path_chr: !r NA_character_
  meso2_bound_yr: !r NA_real_
  meso2_chr: !r NA_character_
  meso2_name_chr: !r NA_character_
  meso2_type_chr: !r NA_character_
  micro_chr_vec: !r NA_character_
  model_end_date: !r Sys.Date()
  model_start_date: !r springtides::aus_pa_r4@temporal_min
  n_its_int: !r NA_real_
  output_params_ls_path_chr: !r NA_character_
  pa_r4_chr: aus_pa_r4
  pa_type_chr: !r NA_character_
  pdf_output_lgl: !r F
  r_data_dir_chr: data
  rendered_by_shiny_lgl: !r F
  sim_data_r4_path_chr: !r NA_character_
  sim_results_ls_path_chr: !r NA_character_
  stat_chr: Prevalence - Annual
  title_chr: Springtides report
  ttime_dbl: !r NA_real_
  uncertainty_1_int: 0.025
  uncertainty_2_int: 0.975
  user_name_chr: !r NA_character_
title: "`r params$title_chr`"
author:
  - "`r params$authorship_1_chr`"
  - "`r params$authorship_2_chr`"
date: "`r format.Date(Sys.Date(),'%B %d, %Y')`"
output:
  word_document: default
  pdf_document:
    fig_caption: yes
  html_document:
    df_print: paged
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
---

```{r echo=F, warning=F, message=F, eval=T}
library(magrittr)
library(kableExtra)
r_data_path_chr <- "C:/Users/mahamilton/Desktop/Readyforwhatsnext/Data/R_Format"
project_data_path_chr <- r_data_path_chr %>% stringr::str_replace("R_Format","Project/COVID19")
path_to_sydney_output_tb <- paste0(project_data_path_chr,"/Copy of Psychological Distress - North Coast outputs.xlsx")
youth_distress_tb <- readxl::read_xlsx(path_to_sydney_output_tb,
                                       range = "L3:U734")
all_distress_tb <- readxl::read_xlsx(path_to_sydney_output_tb,
                                     range = "A3:J734")
scenarios_tb <- readxl::read_excel(path_to_sydney_output_tb,
                                   range = "W3:X9",
                                   col_names = F) %>%
  dplyr::rename(Scenario = ...1,
                Description = ...2)
start_date_dtm <- lubridate::ymd_hms("2011-01-01 00:00:00", 
                                     tz = "Australia/Melbourne") 
youth_distress_tb <- youth_distress_tb %>%
  dplyr::mutate_at(dplyr::vars(dplyr::starts_with('Scen')), .funs = list(RR = ~(1+(.-Baseline)/Baseline))) %>%
  dplyr::mutate(week_starting_dtm = purrr::map_dbl(t,
                                                   ~ start_date_dtm + lubridate::weeks(.x)))
attributes(youth_distress_tb$week_starting_dtm) <- attributes(start_date_dtm)


# if(is.na(params$output_params_ls_path_chr)){
#   output_params_ls <- springtides::make_output_params_ls(input_params_ls = params)
# }else{
#   output_params_ls <- readRDS(params$output_params_ls_path_chr)
# }

```

```{r echo=F, warning=F, message=F, eval=T}
## MAKE FN
pa_dir_chr <- "North_Coast_PHN"
pa_x_params_ls_path_chr <- paste0(project_data_path_chr,
                                    "/",
                                    pa_dir_chr,
                                    "/output_params_ls.rds")
pa_x_params_ls <- readRDS(pa_x_params_ls_path_chr)
prev_params_dbl_vec <- c(which.min(abs(youth_distress_tb$week_starting_dtm-lubridate::ymd_hms("2014-01-01 00:00:00", 
                                     tz = "Australia/Melbourne"))),
                       which.min(abs(youth_distress_tb$week_starting_dtm-lubridate::ymd_hms("2011-01-01 00:00:00", # 2007 not available
                                     tz = "Australia/Melbourne"))))
prev_data_dbl_vec <- youth_distress_tb %>% 
  dplyr::slice(prev_params_dbl_vec) %>%
  dplyr::pull(Baseline)
start_end_dbl_vec <- c(which.min(abs(youth_distress_tb$week_starting_dtm-pa_x_params_ls$sim_data_r4@model_start_date)),
                       which.min(abs(youth_distress_tb$week_starting_dtm-pa_x_params_ls$sim_data_r4@model_end_date)))
RR_tb <- youth_distress_tb %>% dplyr::slice(start_end_dbl_vec)
t0_RR_tb <- RR_tb %>%
  dplyr::slice(1) 
tx_RR_tb <- RR_tb %>%
  dplyr::slice(2) 
base_case_syd_RR_lup <- tibble::tibble(age_dbl = pa_x_params_ls$age_lower:pa_x_params_ls$age_upper,
                                       t0_RR = purrr::map_dbl(age_dbl,
                                                              ~ ifelse(.x<18,
                                                                       1+(t0_RR_tb$Baseline-prev_data_dbl_vec[1])/prev_data_dbl_vec[1],
                                                               1+(t0_RR_tb$Baseline-prev_data_dbl_vec[2])/prev_data_dbl_vec[2]    )
                                                           
                                                                   
                                                                   ),
                                       tx_RR = purrr::map_dbl(age_dbl,
                                                              ~ ifelse(.x<18,
                                                                       1+(tx_RR_tb$Baseline-prev_data_dbl_vec[1])/prev_data_dbl_vec[1],
                                                               1+(tx_RR_tb$Baseline-prev_data_dbl_vec[2])/prev_data_dbl_vec[2]    )
                                                           
                                                                   
                                                                   ))

update_by_col_name_tb <- function(res_tb,col_pfx_chr,time_RR_chr,new_pfx_chr = "SYD_BC_"){
  all_names_chr_vec <- res_tb %>% names()
  target_cols_chr_vec <- all_names_chr_vec[all_names_chr_vec %>% startsWith(col_pfx_chr)]#t0_prev

  sum_cols_chr_vec <- target_cols_chr_vec[endsWith(target_cols_chr_vec,
                                                   "_tl")]
  p_sum_col_chr_vec <- sum_cols_chr_vec[endsWith(sum_cols_chr_vec,
                                                   "p_tl")]
  fm_sum_cols_chr_vec <- sum_cols_chr_vec[sum_cols_chr_vec != p_sum_col_chr_vec] %>% sort()
  target_cols_chr_vec <- target_cols_chr_vec[!target_cols_chr_vec %in% sum_cols_chr_vec]
  target_age_chr_vec <- purrr::map_chr(target_cols_chr_vec,
                                         ~ stringr::str_sub(.x,start=-2))  
    purrr::reduce(1:(length(target_cols_chr_vec)),
                         .init = res_tb,
                  ~ {
                    tb <- .x
                    col_chr <- target_cols_chr_vec[.y]
                    age_dbl <- target_age_chr_vec[.y]
                    RR_dbl <- ready4utils::data_get(base_case_syd_RR_lup,
                                                    lookup_reference = age_dbl,
                                                    lookup_variable = "age_dbl",
                                                    target_variable = time_RR_chr,#"t0_RR"
                                                    evaluate = F)
                    dplyr::mutate(tb,
                                  !!rlang::sym(paste0(new_pfx_chr,
                                                      col_chr)) := purrr::map_dbl(tb %>% 
                                                                                    dplyr::pull(col_chr),
                                                                                  ~ ifelse(identical(.x,
                                                                                                     numeric(0)),
                                                                                                     NA_real_,
                                                                                                     .x * RR_dbl)
                                                                                                   
                                                                                                   )) 
                      
                    
    }) %>%
      purrr::reduce(fm_sum_cols_chr_vec,
                    ~ .x
                    ## ADD FN HERE
                    ) %>%
      ## ADD SUM HERE
}
results_ls <- pa_x_params_ls$sim_results_ls %>%
  purrr::map(~ {
    update_by_col_name_tb(res_tb = .x,
                          col_pfx_chr = "t0_prev",
                          time_RR_chr = "t0_RR")  %>%
          update_by_col_name_tb(col_pfx_chr = "tx_prev",
                          time_RR_chr = "tx_RR") -> test
      
               # dplyr::mutate_at(dplyr::vars(dplyr::starts_with('t0_prev')),
               #                  )
               dplyr::mutate_at(dplyr::vars(dplyr::starts_with('t0_prev')), 
                                       .funs = list(s1_excess = ~ t0_RR_tb$`Scenario 1_RR`*.,
                                                    s2_excess = ~ t0_RR_tb$`Scenario 2_RR` *.,
                                                    s1_i1_excess = ~ t0_RR_tb$`Scen. 1, int. 1_RR` *.,
                                                    s1_i2_excess = ~ t0_RR_tb$`Scen. 1, int. 2_RR` *.,
                                                    s1_i3_excess = ~ t0_RR_tb$`Scen. 1, int. 3_RR` *.,
                                                    s1_i4_excess = ~ t0_RR_tb$`Scen. 1, int. 4_RR` *.,
                                                    s1_i5_excess = ~ t0_RR_tb$`Scen. 1, int. 5_RR` *.)
                                
                                ) %>%
               dplyr::mutate_at(dplyr::vars(dplyr::starts_with('tx_prev')), 
                                       .funs = list(s1_excess = ~ tx_RR_tb$`Scenario 1_RR`*.,
                                                    s2_excess = ~ tx_RR_tb$`Scenario 2_RR` *.,
                                                    s1_i1_excess = ~ tx_RR_tb$`Scen. 1, int. 1_RR` *.,
                                                    s1_i2_excess = ~ tx_RR_tb$`Scen. 1, int. 2_RR` *.,
                                                    s1_i3_excess = ~ tx_RR_tb$`Scen. 1, int. 3_RR` *.,
                                                    s1_i4_excess = ~ tx_RR_tb$`Scen. 1, int. 4_RR` *.,
                                                    s1_i5_excess = ~ tx_RR_tb$`Scen. 1, int. 5_RR` *.)
                                
               ) %>% dplyr::rename_at(
                                  dplyr::vars(ends_with("_excess")), function(x) { toupper(x) }
)
               }
)
```

# RERUN FOR 15-24 PDF


Not for citation or public dissemination. 

# Introduction
## Purpose
This report summarises a set of predictions about the `r output_params_ls$tfd_stat_chr %>% tolower()` in young people aged between `r output_params_ls$age_lower` and `r output_params_ls$age_upper` for the `r output_params_ls$meso2_name_chr` between `r output_params_ls$tfd_start_date_chr` And `r output_params_ls$tfd_end_date_chr`. The document also describes some of the key features of the model used to generate these predictions, describes the level of uncertainty associated with the predictions and some of the strengths and limitations of the methods and data sources used in the predictive model.

## About Springtides
This report has been automatically generated by the development version of the Springtides App. The Springtides App provides a web based user interface to a computer simulation model of youth mental health epidemiology. The Springtides app and simulation model was developed by Orygen in the statistical software R using the readyforwhatsnext open source modelling framework. The source code for both Springtides and readyforwhatsnext is due for public release as R packages later in 2020. Currently, access to these code libraries is by invitation only as testing is currently ongoing. As this report is generated by the development version of the Springtides App, readers of this report are encouraged to cross reference report findings with other data sources and to report any suspected errors to the Springtides development team. 

# Methods
## Data sources
Currently, all input data used by the Springtides model are Australia specific. Most of the input data is freely available on the Internet and released under permissive licensing arrangements. `r ifelse(output_params_ls$format_chr=="HTML","Links to all such open data is included in the tables that summarise model inputs.","")`  Some input data were collated from reviews of relevant literature by the Springtides development team and collectively form part of the Springtides Replication Dataset. The replication dataset is currently stored in a private online data repository but is due for public release later in 2020.


### Geometries
The geometry data include data on the boundaries of a range of Australian spatial units (Table 1) `r ifelse(output_params_ls$meso2_type_chr=="HSS"," and point coordinates of service centre locations (Table 2)","")`. The boundary data source files are available for download direct from their publisher in the form of ESRI shape files.`r ifelse(output_params_ls$meso2_type_chr=="HSS"," The point coordinate data relate to the locations of headspace centres across Australia.","")` 


```{r echo=F, warning=F, bootstrap.show.code = FALSE}
output_params_ls$input_tables_ls$boundary_input_lup_tb
```


```{r echo=F, warning=F, bootstrap.show.code = FALSE}
if(output_params_ls$input_ls$pa_r4@area_type=="HSS"){
  output_params_ls$input_tables_ls$point_crd_input_kb
}
```

\pagebreak

### Spatial Attributes
The sources for the spatial attribute data that were used to generate this report are summarised in Table `r length(output_params_ls$input_tables_ls)-1`. 


```{r echo=F, warning=F, bootstrap.show.code = FALSE}
output_params_ls$input_tables_ls$attributes_input_kb
```

The values of the epidemiology parameters in the Springtides Replication Dataset along with details about the relevant evidence sources are summarised in Table `r length(output_params_ls$input_tables_ls)`.

```{r echo=F, warning=F}
output_params_ls$input_tables_ls$epi_inputs_kb
```
## Algorithm
The algorithm that produced the predictions in this report first `r ifelse(output_params_ls$pa_type_chr!="Predefined boundary","generated","retrieved")` the geometries that describe `r output_params_ls$meso2_name_chr`. To speed processing times, these geometries have been simplified to reduce the density of points in each shape, using an algorithm that preserves topology. These geometries are next synthesised with spatial attribute data that include census counts, population projections, the mean prediction errors for previous official population projections and age and sex `r output_params_ls$tfd_stat_rate_chr %>% tolower()` rates for `r output_params_ls$disorder_chr %>% stringr::str_replace_all("_"," ")`. As these attribute data are reported at different levels of spatial resolution, the geometry representing `r output_params_ls$meso2_name_chr` is divided into sub-units of varying sizes in order for the highest available resolution to be used for each attribute. Population counts and population projection data are used to predict the future resident population of `r output_params_ls$age_lower` to `r output_params_ls$age_upper` year olds by sex for each area sub-unit. These resident population predictions are then multiplied by age and sex based `r output_params_ls$tfd_stat_rate_chr %>% tolower()` rates to produce the `r output_params_ls$tfd_stat_rate_chr %>% tolower()` predictions, which are summed to produce a total prediction for `r output_params_ls$meso2_name_chr`. To account for uncertainty in population projections and `r output_params_ls$tfd_stat_rate_chr %>% tolower()` rate parameters, this process was repeated `r output_params_ls$n_its_int` times, each time drawing different values from the probability distributions of these parameters. The parameter uncertainty that is explored by this process relates to population growth rates and `r output_params_ls$tfd_stat_rate_chr %>% tolower()` rates. Structural uncertainty relating to geometry simplifcation, the assumed uniform distribution of counts at spatial resolutions greater than that for which reported data were available and the selection of data sources was not explored. 

\pagebreak

# Results

## Demographic Results
The predicted population of `r output_params_ls$age_lower` to `r output_params_ls$age_upper` year olds resident in `r output_params_ls$meso2_name_chr` is summarised in the following nine tables and nine figures.

### `r paste0(output_params_ls$tfd_start_date_chr, " Resident Population ", ifelse(output_params_ls$y0_prediction_lgl,"Predictions","Estimates"))`


```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[1]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_1}

output_params_ls$output_plots_ls$Figure_1


```

\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[2]]
```



```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_2}
output_params_ls$output_plots_ls$Figure_2
```


\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[3]]
```

```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_3}
output_params_ls$output_plots_ls$Figure_3
```

\pagebreak

### `r paste0(output_params_ls$tfd_end_date_chr, " Resident Population Predictions")`

```{r echo=F, warning=F}
 output_params_ls$output_tables_ls[[4]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_4}
output_params_ls$output_plots_ls$Figure_4
```

\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[5]]
```

```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_5}
output_params_ls$output_plots_ls$Figure_5
```

\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[6]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_6}
output_params_ls$output_plots_ls$Figure_6
```

\pagebreak

### `r paste0("Predicted Change in Resident Population Between ", output_params_ls$tfd_start_date_chr, " and ",output_params_ls$tfd_end_date_chr)`

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[7]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_7}
output_params_ls$output_plots_ls$Figure_7
```


\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[8]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_8}
output_params_ls$output_plots_ls$Figure_8
```

\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[9]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_9}
output_params_ls$output_plots_ls$Figure_9
```

\pagebreak

## `r output_params_ls$tfd_stat_chr` Results
The predicted `r output_params_ls$tfd_stat_chr %>% tolower()` amongst `r output_params_ls$age_lower` to `r output_params_ls$age_upper` year olds resident in `r output_params_ls$meso2_name_chr` is summarised in the next nine tables and nine figures.

### `r paste0(output_params_ls$tfd_start_date_chr," ",output_params_ls$tfd_stat_chr, " Predictions")`

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[10]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_10}
output_params_ls$output_plots_ls$Figure_10
```

\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[11]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_11}
output_params_ls$output_plots_ls$Figure_11
```

\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[12]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_12}
output_params_ls$output_plots_ls$Figure_12
```

\pagebreak

### `r paste0(output_params_ls$tfd_end_date_chr," ",output_params_ls$tfd_stat_chr, " Predictions")`

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[13]]
```

```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_13}
output_params_ls$output_plots_ls$Figure_13
```

\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[14]]
```

```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_14}
output_params_ls$output_plots_ls$Figure_14
```

\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[15]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_15}
output_params_ls$output_plots_ls$Figure_15
```

\pagebreak

### `r paste0("Predicted Change in "," ",output_params_ls$tfd_stat_chr," Between ", output_params_ls$tfd_start_date_chr, " and ",output_params_ls$tfd_end_date_chr)`

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[16]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_16}
output_params_ls$output_plots_ls$Figure_16
```

\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[17]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_17}
output_params_ls$output_plots_ls$Figure_17
```

\pagebreak

```{r echo=F, warning=F}
output_params_ls$output_tables_ls[[18]]
```


```{r echo=F, warning=F, fig.cap=output_params_ls$output_plots_titles_ls$Figure_18}
output_params_ls$output_plots_ls$Figure_18
```

\pagebreak

# Discussion
The results presented in this report are produced by an algorithm that synthesises Australian geometry and spatial attribute data. Strengths of this automated approach include the relevance of the input data to the Australian context and using data at the highest available spatial resolution. However, there are also a number of limitations that users of this report should bear in mind when interpreting report results.

First and most importantly, this report is produced by a development version of the Springtides App, which means both the application and its underlying model are only partially verified and validated. An updated version of the Springtides App will be released once user testing, code and input data verification and validation checks have been completed. Secondly, uncertainty is only partially explored and the true uncertainty of model outputs will be greater than that described in this report. Some model inputs currently only have deterministic values, structural uncertainty is not yet explored and to conserve computing resources we have restricted Springtides App users to running a maximum of 100 iterations of each simulation. We will be shortly addressing each of these constraints in a forthcoming development release as well as providing opportunities to explore structural uncertainty through selection of alternative evidence sources for a number of model parameters. Thirdly, epidemiology estimates are currently based on age and sex predictors only. Area attributes such as urbanicity and socioeconomic status will be added to the predictors in a forthcoming development version release.  

# Contact
You can help improve the Springtides App by reporting any suspected errors or providing usability feedback to the Springtides development team. Email: matthew.hamilton@orygen.org.au

```{r echo=F, warning=F}
# if(output_params_ls$rendered_by_shiny_lgl)
#   shiny::setProgress(1, message = "Step five: Wrap up") 
```
